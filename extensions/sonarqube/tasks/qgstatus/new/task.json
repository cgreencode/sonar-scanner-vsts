{
  "id": "c8017058-c274-47e7-b9ce-8f1cb6aa444c",
  "name": "SonarQubeQualityGateCheck",
  "friendlyName": "Check SonarQube QualityGate status for a build.",
  "description": "SonarQube QualityGate status check for a build.",
  "helpMarkDown": "",
  "category": "Deploy",
  "visibility": ["Release"],
  "runsOn": ["ServerGate"],
  "author": "sonarsource",
  "version": {
    "Major": 1,
    "Minor": 0,
    "Patch": 0
  },
  "preview": "true",
  "inputs": [
    {
      "name": "SonarQube",
      "type": "connectedService:sonarqube",
      "label": "SonarQube Service Endpoint",
      "required": true,
      "helpMarkDown": "Select the SonarQube endpoint for your project. To create one, click the Manage link and create a new SonarQube Service Endpoint, then enter your SonarQube account token and instance url."
    }
  ],
  "instanceNameFormat": "Check SonarQube Quality Gate Status",
  "execution": {
    "HttpRequestChain": {
      "Execute": [
        {
          "RequestInputs": {
            "EndpointUrl": "$(system.teamFoundationCollectionUri)$(system.teamProjectId)/_apis/distributedtask/variablegroups?groupName=SonarCloud&api-version=5.0-preview.1",
            "Method": "GET",
            "Headers": "{\n\"Content-Type\":\"application/json\", \n\"Authorization\": \"Bearer  $(system.accesstoken)\"\n}"
          },
          "ExecutionOptions": {
            "OutputVariables": {
              "ceTaskId": "jsonpath('$..[''$(build.buildNumber)''].value')[0]"
            }
          }
        },
        {
          "RequestInputs": {
            "EndpointId": "$(SonarQube)",
            "EndpointUrl": "$(endpoint.url)api/ce/task?id=$(ceTaskId)",
            "Method": "GET"
          },
          "ExecutionOptions": {
            "OutputVariables": {
              "analysisId": "jsonpath('$.task.analysisId')[0]"
            }
          }
        },
        {
          "RequestInputs": {
            "EndpointId": "$(SonarQube)",
            "EndpointUrl": "$(endpoint.url)api/qualitygates/project_status?analysisId=$(analysisId)",
            "Method": "GET",
            "Expression": "eq(jsonpath('$.projectStatus.status')[0], 'OK')"
          }
        }
      ]
    }
  }
}
